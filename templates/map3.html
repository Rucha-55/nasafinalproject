{% extends "base.html" %}

{% block title %}Satellite Map Analysis with AI Segmentation{% endblock %}

{% block extra_css %}
    <!-- Leaflet CSS -->
    <link rel="stylesheet" href="https://unpkg.com/leaflet/dist/leaflet.css" />
    <!-- Leaflet Draw CSS -->
    <link rel="stylesheet" href="https://unpkg.com/leaflet-draw/dist/leaflet.draw.css" />
    
    <style>
        body { font-family: Arial, sans-serif; margin: 0; padding: 0; }
        .container { display: flex; height: 100vh; }
        .map-container { flex: 2; }
        .results-container { flex: 1; padding: 20px; overflow-y: auto; background: var(--card-bg); }
        #map { height: 100%; width: 100%; }
        .btn { padding: 10px 20px; font-size: 16px; background: var(--accent-1); color: white; border: none; border-radius: var(--radius-sm); cursor: pointer; margin: 5px; }
        .btn:hover { background: var(--accent-2); }
        .btn:disabled { background: var(--text-muted); cursor: not-allowed; }
        .stats-container { background: var(--card-bg); padding: 15px; margin: 10px 0; border-radius: var(--radius-md); box-shadow: var(--elevation-1); }
        .stat-item { display: flex; justify-content: space-between; margin: 5px 0; padding: 5px; border-left: 4px solid var(--accent-1); background: var(--glass); }
        .loading { text-align: center; padding: 20px; color: var(--text-secondary); }
        .error { color: var(--accent-3); padding: 10px; background: rgba(255,107,107,0.1); border-radius: var(--radius-sm); margin: 10px 0; }
        .success { color: var(--success); padding: 10px; background: rgba(126,231,135,0.1); border-radius: var(--radius-sm); margin: 10px 0; }
        .chart-container { text-align: center; margin: 20px 0; }
        .chart-container img { max-width: 100%; border-radius: var(--radius-md); box-shadow: var(--elevation-1); }
        .header { text-align: center; padding: 10px; background: linear-gradient(135deg, var(--accent-1), var(--accent-2)); color: white; }
        .progress-bar { width: 100%; background: var(--glass); border-radius: var(--radius-sm); margin: 10px 0; }
        .progress-fill { height: 20px; background: linear-gradient(90deg, var(--accent-1), var(--accent-2)); border-radius: var(--radius-sm); transition: width var(--transition-normal); }
        .search-container { 
            position: absolute; 
            top: 10px; 
            left: 10px; 
            z-index: 10000; 
            background: var(--card-bg); 
            padding: 20px; 
            border-radius: var(--radius-lg); 
            box-shadow: var(--elevation-2);
            min-width: 320px;
            border: 2px solid var(--accent-1);
        }
        .search-input { 
            width: 100%; 
            padding: 10px; 
            border: 2px solid rgba(255,255,255,0.1); 
            border-radius: var(--radius-sm); 
            font-size: 14px; 
            margin-bottom: 10px;
            background: var(--glass);
            color: var(--text-primary);
        }
        .search-input:focus { 
            outline: none; 
            border-color: var(--accent-1); 
        }
        .search-btn { 
            background: var(--accent-1); 
            color: white; 
            border: none; 
            padding: 8px 15px; 
            border-radius: var(--radius-sm); 
            cursor: pointer; 
            margin-right: 5px;
            font-size: 12px;
        }
        .search-btn:hover { 
            background: var(--accent-2); 
        }
        .search-example { 
            font-size: 11px; 
            color: var(--text-muted); 
            margin-top: 5px; 
        }
        .search-results { 
            max-height: 150px; 
            overflow-y: auto; 
            border: 1px solid rgba(255,255,255,0.1); 
            border-radius: var(--radius-sm); 
            margin-top: 5px; 
            display: none;
            background: var(--card-bg);
        }
        .search-result-item { 
            padding: 8px; 
            cursor: pointer; 
            border-bottom: 1px solid rgba(255,255,255,0.05); 
            color: var(--text-secondary);
        }
        .search-result-item:hover { 
            background: var(--glass-hover); 
            color: var(--text-primary);
        }
        @media (max-width: 768px) {
            .search-container {
                position: relative;
                top: 0;
                left: 0;
                margin: 10px;
                min-width: auto;
                width: calc(100% - 20px);
            }
            .container {
                flex-direction: column;
            }
            .map-container {
                height: 60vh;
            }
            .results-container {
                height: 40vh;
            }
        }
    </style>
{% endblock %}

{% block content %}
    <div class="header">
        <h2>üõ∞Ô∏è Mission Control: Satellite Map Analysis</h2>
        <p>Select an area on the map to analyze land use patterns using advanced AI algorithms</p>
        
        <!-- Header Search Bar -->
        <div style="max-width: 600px; margin: 10px auto; background: rgba(255,255,255,0.9); padding: 15px; border-radius: 8px;">
            <div style="display: flex; gap: 10px; align-items: center; flex-wrap: wrap;">
                <input type="text" id="header-search-input" placeholder="Search city or coordinates (e.g., New York, 40.7128,-74.0060)" 
                       style="flex: 1; min-width: 250px; padding: 8px; border: 1px solid #ddd; border-radius: 4px;">
                <button onclick="headerSearchLocation()" style="background: #fff; color: #0078d7; border: 1px solid #0078d7; padding: 8px 15px; border-radius: 4px; cursor: pointer;">üåç Search</button>
                <button onclick="getCurrentLocation()" style="background: #fff; color: #0078d7; border: 1px solid #0078d7; padding: 8px 15px; border-radius: 4px; cursor: pointer;">üìç My Location</button>
                <button onclick="showPopularLocations()" style="background: #fff; color: #0078d7; border: 1px solid #0078d7; padding: 8px 15px; border-radius: 4px; cursor: pointer;">‚≠ê Popular</button>
            </div>
            <div id="header-search-results" style="max-height: 150px; overflow-y: auto; margin-top: 10px; background: white; border-radius: 4px; display: none;"></div>
        </div>
    </div>
    
    <div class="container">
        <div class="map-container" style="position: relative;">
            <div id="map"></div>
            
            <!-- HIGHLY VISIBLE SEARCH BAR -->
            <div style="
                position: absolute;
                top: 20px;
                left: 20px;
                background: linear-gradient(45deg, #ff6b6b, #4ecdc4);
                padding: 20px;
                border-radius: 15px;
                z-index: 10000;
                box-shadow: 0 8px 32px rgba(0,0,0,0.3);
                min-width: 350px;
                border: 3px solid #fff;
            ">
                <h3 style="color: white; margin: 0 0 15px 0; text-align: center; text-shadow: 1px 1px 2px rgba(0,0,0,0.5);">
                    üåç SEARCH LOCATIONS üîç
                </h3>
                <input 
                    type="text" 
                    id="main-search-input" 
                    placeholder="Enter city name or coordinates (lat,lng)"
                    onkeypress="if(event.key==='Enter') mainSearchLocation()"
                    style="
                        width: 100%;
                        padding: 12px;
                        border: none;
                        border-radius: 8px;
                        font-size: 16px;
                        box-sizing: border-box;
                        box-shadow: inset 0 2px 4px rgba(0,0,0,0.1);
                    "
                />
                <div style="margin-top: 10px; display: flex; gap: 8px; flex-wrap: wrap; justify-content: center;">
                    <button onclick="mainSearchLocation()" style="
                        background: #fff;
                        color: #333;
                        border: none;
                        padding: 10px 15px;
                        border-radius: 20px;
                        cursor: pointer;
                        font-weight: bold;
                        box-shadow: 0 2px 8px rgba(0,0,0,0.2);
                        transition: transform 0.2s;
                    " onmouseover="this.style.transform='scale(1.05)'" onmouseout="this.style.transform='scale(1)'">
                        üîç Search
                    </button>
                    <button onclick="getCurrentLocation()" style="
                        background: #fff;
                        color: #333;
                        border: none;
                        padding: 10px 15px;
                        border-radius: 20px;
                        cursor: pointer;
                        font-weight: bold;
                        box-shadow: 0 2px 8px rgba(0,0,0,0.2);
                        transition: transform 0.2s;
                    " onmouseover="this.style.transform='scale(1.05)'" onmouseout="this.style.transform='scale(1)'">
                        üìç My Location
                    </button>
                    <button onclick="showPopularLocations()" style="
                        background: #fff;
                        color: #333;
                        border: none;
                        padding: 10px 15px;
                        border-radius: 20px;
                        cursor: pointer;
                        font-weight: bold;
                        box-shadow: 0 2px 8px rgba(0,0,0,0.2);
                        transition: transform 0.2s;
                    " onmouseover="this.style.transform='scale(1.05)'" onmouseout="this.style.transform='scale(1)'">
                        üåü Popular
                    </button>
                </div>
                <div id="main-search-results" style="
                    background: white;
                    border-radius: 8px;
                    max-height: 200px;
                    overflow-y: auto;
                    margin-top: 10px;
                    display: none;
                    box-shadow: 0 4px 12px rgba(0,0,0,0.2);
                "></div>
            </div>
            
            <!-- Search Container -->
            <div class="search-container" id="search-container">
                <h4 style="margin: 0 0 10px 0; color: var(--text-primary); font-weight: bold;">üîç Mission Location Search</h4>
                <input type="text" id="search-input" class="search-input" placeholder="Search by city name or coordinates (28.6139, 77.2090)">
                <div>
                    <button onclick="searchLocation()" class="search-btn">üåç Search</button>
                    <button onclick="getCurrentLocation()" class="search-btn">üìç My Location</button>
                    <button onclick="showPopularLocations()" class="search-btn">‚≠ê Popular</button>
                </div>
                <div class="search-example">
                    Examples: "New York", "Tokyo", "28.6139, 77.2090", "40.7128 -74.0060"
                </div>
                <div id="search-results" class="search-results"></div>
            </div>
        </div>
        
        <div class="results-container">
            <button id="generate-patches-btn" class="btn" style="display:none;">üöÄ Launch Area Analysis</button>
            <button id="clear-selection-btn" class="btn" onclick="clearSelection()">üóëÔ∏è Clear Selection</button>
            
            <div id="status-message"></div>
            <div id="progress-container" style="display:none;">
                <div class="progress-bar">
                    <div id="progress-fill" class="progress-fill" style="width: 0%;"></div>
                </div>
                <div id="progress-text">Processing...</div>
            </div>
            
            <div id="results-section" style="display:none;">
                <div class="stats-container">
                    <h3 style="color: var(--text-primary); margin-bottom: 15px;">üìä Mission Analysis Results</h3>
                    <div id="analysis-summary"></div>
                    <div id="average-statistics"></div>
                </div>
                
                <div class="chart-container" id="chart-container" style="display:none;">
                    <h4 style="color: var(--text-primary); margin-bottom: 15px;">üìà Land Use Distribution</h4>
                    <img id="analysis-chart" src="" alt="Analysis Chart">
                </div>
            </div>
        </div>
    </div>

    <!-- Leaflet JS -->
    <script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>
    <!-- Leaflet Draw JS -->
    <script src="https://unpkg.com/leaflet-draw/dist/leaflet.draw.js"></script>
    <!-- leaflet-image for rendering map as image -->
    <script src="https://unpkg.com/leaflet-image/leaflet-image.js"></script>

    <script>
    // Initialize map (Delhi, India by default)
    var map = L.map('map').setView([28.6139, 77.2090], 10);

    // ‚úÖ Satellite layer (Esri World Imagery)
    var satelliteLayer = L.tileLayer(
        'https://server.arcgisonline.com/ArcGIS/rest/services/World_Imagery/MapServer/tile/{z}/{y}/{x}',
        {
            attribution: 'Tiles ¬© Esri, Maxar, Earthstar Geographics, USDA, USGS',
            maxZoom: 17   // safe max zoom for global coverage
        }
    ).addTo(map);

    // Ensure search container is visible
    document.addEventListener('DOMContentLoaded', function() {
        const searchContainer = document.getElementById('search-container');
        if (searchContainer) {
            searchContainer.style.display = 'block';
            searchContainer.style.visibility = 'visible';
            console.log('Search container is visible:', searchContainer.offsetWidth > 0);
        } else {
            console.error('Search container not found!');
        }
    });

    // Add draw control
    var drawnItems = new L.FeatureGroup();
    map.addLayer(drawnItems);
    var drawControl = new L.Control.Draw({
        draw: {
            polygon: false,
            polyline: false,
            circle: false,
            marker: false,
            circlemarker: false,
            rectangle: true
        },
        edit: { featureGroup: drawnItems }
    });
    map.addControl(drawControl);

    // Global variables
    var selectedBounds = null;
    var collectedPatches = [];

    // Handle area selection
    map.on(L.Draw.Event.CREATED, function (e) {
        drawnItems.clearLayers();
        var layer = e.layer;
        drawnItems.addLayer(layer);
        selectedBounds = layer.getBounds();
        document.getElementById('generate-patches-btn').style.display = 'inline-block';
        showMessage('Area selected! Click "Analyze Selected Area" to process.', 'success');
    });

    // Clear selection function
    function clearSelection() {
        drawnItems.clearLayers();
        selectedBounds = null;
        document.getElementById('generate-patches-btn').style.display = 'none';
        document.getElementById('results-section').style.display = 'none';
        document.getElementById('progress-container').style.display = 'none';
        showMessage('Selection cleared.', 'success');
    }

    // Search functionality
    async function searchLocation() {
        const query = document.getElementById('search-input').value.trim();
        performSearch(query, 'search-results');
    }

    async function mainSearchLocation() {
        const query = document.getElementById('main-search-input').value.trim();
        performSearch(query, 'main-search-results');
    }

    async function headerSearchLocation() {
        const query = document.getElementById('header-search-input').value.trim();
        performSearch(query, 'header-search-results');
    }

    async function performSearch(query, resultsElementId) {
        if (!query) {
            showMessage('Please enter a search term.', 'error');
            return;
        }

        // Check if input looks like coordinates (supports multiple formats)
        const coordPattern = /^-?\d+\.?\d*\s*[,\s]\s*-?\d+\.?\d*$/;
        if (coordPattern.test(query)) {
            const coords = query.split(/[,\s]+/).map(coord => parseFloat(coord.trim()));
            const lat = coords[0];
            const lng = coords[1];
            
            if (lat >= -90 && lat <= 90 && lng >= -180 && lng <= 180) {
                moveToLocation(lat, lng, `Coordinates: ${lat.toFixed(4)}, ${lng.toFixed(4)}`);
                return;
            } else {
                showMessage('Invalid coordinates. Latitude must be between -90 and 90, longitude between -180 and 180.', 'error');
                return;
            }
        }

        // Search by place name using Nominatim (OpenStreetMap)
        try {
            showMessage('Searching...', 'loading');
            const response = await fetch(`https://nominatim.openstreetmap.org/search?format=json&q=${encodeURIComponent(query)}&limit=5`);
            const results = await response.json();
            
            if (results && results.length > 0) {
                displaySearchResults(results, resultsElementId);
            } else {
                showMessage('No results found. Try a different search term.', 'error');
            }
        } catch (error) {
            console.error('Search error:', error);
            showMessage('Search failed. Please try again.', 'error');
        }
    }

    function displaySearchResults(results, resultsElementId) {
        const resultsContainer = document.getElementById(resultsElementId);
        resultsContainer.innerHTML = '';
        
        results.forEach((result, index) => {
            const item = document.createElement('div');
            item.className = 'search-result-item';
            item.style.cssText = 'padding: 8px; cursor: pointer; border-bottom: 1px solid #eee;';
            item.innerHTML = `
                <strong>${result.display_name.split(',')[0]}</strong><br>
                <small>${result.display_name}</small>
            `;
            item.onmouseover = () => item.style.background = '#f5f5f5';
            item.onmouseout = () => item.style.background = '';
            item.onclick = () => {
                moveToLocation(parseFloat(result.lat), parseFloat(result.lon), result.display_name);
                resultsContainer.style.display = 'none';
            };
            resultsContainer.appendChild(item);
        });
        
        resultsContainer.style.display = 'block';
    }

    function moveToLocation(lat, lng, name) {
        map.setView([lat, lng], 13);
        
        // Add a temporary marker
        const marker = L.marker([lat, lng]).addTo(map);
        marker.bindPopup(`üìç ${name}`).openPopup();
        
        // Remove marker after 5 seconds
        setTimeout(() => {
            map.removeLayer(marker);
        }, 5000);
        
        showMessage(`Moved to: ${name}`, 'success');
        document.getElementById('search-input').value = '';
        document.getElementById('search-results').style.display = 'none';
    }

    function getCurrentLocation() {
        if (!navigator.geolocation) {
            showMessage('Geolocation is not supported by this browser.', 'error');
            return;
        }

        showMessage('Getting your location...', 'loading');
        
        navigator.geolocation.getCurrentPosition(
            (position) => {
                const lat = position.coords.latitude;
                const lng = position.coords.longitude;
                moveToLocation(lat, lng, 'Your Current Location');
            },
            (error) => {
                let message = 'Unable to get your location. ';
                switch(error.code) {
                    case error.PERMISSION_DENIED:
                        message += 'Please allow location access.';
                        break;
                    case error.POSITION_UNAVAILABLE:
                        message += 'Location information unavailable.';
                        break;
                    case error.TIMEOUT:
                        message += 'Location request timed out.';
                        break;
                    default:
                        message += 'An unknown error occurred.';
                        break;
                }
                showMessage(message, 'error');
            },
            {
                enableHighAccuracy: true,
                timeout: 10000,
                maximumAge: 0
            }
        );
    }

    function showPopularLocations() {
        const popularLocations = [
            { name: "üèôÔ∏è New York City", lat: 40.7128, lng: -74.0060 },
            { name: "üóº Tokyo", lat: 35.6762, lng: 139.6503 },
            { name: "üèõÔ∏è Delhi", lat: 28.6139, lng: 77.2090 },
            { name: "üåâ San Francisco", lat: 37.7749, lng: -122.4194 },
            { name: "üé° London", lat: 51.5074, lng: -0.1278 },
            { name: "üèîÔ∏è Dubai", lat: 25.2048, lng: 55.2708 },
            { name: "üèñÔ∏è Miami", lat: 25.7617, lng: -80.1918 },
            { name: "üèûÔ∏è Singapore", lat: 1.3521, lng: 103.8198 }
        ];
        
        // Try main results first, then header results, fallback to sidebar results
        const resultsContainer = document.getElementById('main-search-results') || 
                                document.getElementById('header-search-results') || 
                                document.getElementById('search-results');
        resultsContainer.innerHTML = '';
        
        popularLocations.forEach(location => {
            const item = document.createElement('div');
            item.style.cssText = 'padding: 8px; cursor: pointer; border-bottom: 1px solid #eee;';
            item.innerHTML = `<strong>${location.name}</strong><br><small>Lat: ${location.lat}, Lng: ${location.lng}</small>`;
            item.onmouseover = () => item.style.background = '#f5f5f5';
            item.onmouseout = () => item.style.background = '';
            item.onclick = () => {
                moveToLocation(location.lat, location.lng, location.name);
                resultsContainer.style.display = 'none';
            };
            resultsContainer.appendChild(item);
        });
        
        resultsContainer.style.display = 'block';
    }

    // Enable search on Enter key
    document.getElementById('search-input').addEventListener('keypress', function(e) {
        if (e.key === 'Enter') {
            searchLocation();
        }
    });

    // Hide search results when clicking outside
    document.addEventListener('click', function(e) {
        const searchContainer = document.querySelector('.search-container');
        const resultsContainer = document.getElementById('search-results');
        
        if (!searchContainer.contains(e.target)) {
            resultsContainer.style.display = 'none';
        }
    });

    // Show message function
    function showMessage(message, type = 'info') {
        const statusDiv = document.getElementById('status-message');
        statusDiv.innerHTML = `<div class="${type}">${message}</div>`;
        if (type === 'success' || type === 'info') {
            setTimeout(() => statusDiv.innerHTML = '', 3000);
        }
    }

    // Update progress
    function updateProgress(percent, text) {
        document.getElementById('progress-container').style.display = 'block';
        document.getElementById('progress-fill').style.width = percent + '%';
        document.getElementById('progress-text').textContent = text;
    }

    // Helpers for pixel/latlng conversion
    function latLngToPixel(latlng, zoom) { return map.project(latlng, zoom); }
    function pixelToLatLng(point, zoom) { return map.unproject(point, zoom); }

    // Resolution ‚Üí zoom level (limit max zoom to 17 for Esri)
    function getZoomForResolution(mpp) {
        var lat = map.getCenter().lat;
        var maxAvailableZoom = 17;
        for (var z = maxAvailableZoom; z >= 0; z--) {
            var mppCalc = 156543.03392 * Math.cos(lat * Math.PI / 180) / Math.pow(2, z);
            if (mppCalc <= mpp) return z;
        }
        return maxAvailableZoom;
    }

    // Main: Generate patches and send to backend
    function generatePatches(bounds) {
        updateProgress(10, 'Preparing patches...');
        collectedPatches = [];
        
        var zoom = getZoomForResolution(5); // ~5m/px for reliable coverage
        map.setZoom(zoom);

        var nw = bounds.getNorthWest();
        var se = bounds.getSouthEast();
        var nwPixel = latLngToPixel(nw, zoom);
        var sePixel = latLngToPixel(se, zoom);

        var patchSize = 512;  // patch size
        var xStart = Math.floor(nwPixel.x);
        var yStart = Math.floor(nwPixel.y);
        var xEnd = Math.ceil(sePixel.x);
        var yEnd = Math.ceil(sePixel.y);

        var totalPatches = Math.ceil((xEnd-xStart)/patchSize) * Math.ceil((yEnd-yStart)/patchSize);
        
        if ((xEnd-xStart) < patchSize || (yEnd-yStart) < patchSize || totalPatches < 1) {
            showMessage("Selected area is too small for analysis. Please select a larger area.", 'error');
            document.getElementById('progress-container').style.display = 'none';
            return;
        }

        if (totalPatches > 20) {
            showMessage(`Selected area will generate ${totalPatches} patches. This may take a while to process.`, 'info');
        }

        updateProgress(20, `Processing ${totalPatches} patches...`);

        var patchCount = 0, loadedPatches = 0;
        for (var x = xStart; x < xEnd; x += patchSize) {
            for (var y = yStart; y < yEnd; y += patchSize) {
                var patchNW = pixelToLatLng(L.point(x, y), zoom);
                var patchSE = pixelToLatLng(L.point(x + patchSize, y + patchSize), zoom);
                var patchBounds = L.latLngBounds(patchNW, patchSE);
                
                createPatchImage(patchBounds, zoom, ++patchCount, function(patchData) {
                    loadedPatches++;
                    if (patchData) {
                        collectedPatches.push(patchData);
                    }
                    
                    var progress = 20 + (loadedPatches / totalPatches) * 60;
                    updateProgress(progress, `Collected ${loadedPatches}/${totalPatches} patches...`);
                    
                    if (loadedPatches === totalPatches) {
                        sendPatchesToBackend();
                    }
                });
            }
        }
    }

    // Send collected patches to backend for analysis
    function sendPatchesToBackend() {
        updateProgress(80, 'Analyzing patches with AI model...');
        
        fetch('/process-map-patches', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
            },
            body: JSON.stringify({
                patches: collectedPatches
            })
        })
        .then(response => response.json())
        .then(data => {
            updateProgress(100, 'Analysis complete!');
            setTimeout(() => {
                document.getElementById('progress-container').style.display = 'none';
                displayResults(data);
            }, 1000);
        })
        .catch(error => {
            console.error('Error:', error);
            showMessage('Error processing patches: ' + error.message, 'error');
            document.getElementById('progress-container').style.display = 'none';
        });
    }

    // Display analysis results
    function displayResults(data) {
        if (!data.success) {
            showMessage('Analysis failed: ' + data.error, 'error');
            return;
        }

        // Show results section
        document.getElementById('results-section').style.display = 'block';
        
        // Summary
        const summary = `
            <div class="stat-item">
                <span><strong>Total Patches Analyzed:</strong></span>
                <span>${data.processed_patches}/${data.total_patches}</span>
            </div>
            <div class="stat-item">
                <span><strong>Total Pixels Analyzed:</strong></span>
                <span>${data.total_pixels_analyzed.toLocaleString()}</span>
            </div>
        `;
        document.getElementById('analysis-summary').innerHTML = summary;
        
        // Average statistics
        let statsHtml = '<h4>üåç Land Use Distribution</h4>';
        for (const [className, stats] of Object.entries(data.average_statistics)) {
            if (stats.percentage > 0) {
                statsHtml += `
                    <div class="stat-item">
                        <span><strong>${className}:</strong></span>
                        <span>${stats.percentage}% (${stats.total_pixels.toLocaleString()} pixels)</span>
                    </div>
                `;
            }
        }
        document.getElementById('average-statistics').innerHTML = statsHtml;
        
        // Chart
        if (data.chart_image) {
            document.getElementById('chart-container').style.display = 'block';
            document.getElementById('analysis-chart').src = '/' + data.chart_image + '?t=' + Date.now();
        }
        
        showMessage('‚úÖ Analysis completed successfully!', 'success');
    }

    // Button event
    document.getElementById('generate-patches-btn').onclick = function() {
        if (selectedBounds) {
            generatePatches(selectedBounds);
            this.disabled = true;
            setTimeout(() => { this.disabled = false; }, 5000);
        }
    };

    // Create patch image
    function createPatchImage(bounds, zoom, idx, onDone) {
        var patchDiv = document.createElement('div');
        patchDiv.style.width = '512px';
        patchDiv.style.height = '512px';
        patchDiv.style.position = 'absolute';
        patchDiv.style.left = '-9999px';
        patchDiv.style.top = '-9999px';
        document.body.appendChild(patchDiv);

        var patchMap = L.map(patchDiv, {
            attributionControl: false,
            zoomControl: false,
            center: bounds.getCenter(),
            zoom: zoom,
            layers: [
                L.tileLayer('https://server.arcgisonline.com/ArcGIS/rest/services/World_Imagery/MapServer/tile/{z}/{y}/{x}',
                    { maxZoom: 17 })
            ]
        });
        patchMap.fitBounds(bounds);

        setTimeout(function () {
            leafletImage(patchMap, function (err, canvas) {
                var patchData = null;
                if (!err && canvas) {
                    patchData = canvas.toDataURL();
                }
                patchMap.remove(); 
                patchDiv.remove();
                if (onDone) onDone(patchData);
            });
        }, 2000); // wait for tiles to load
    }
    </script>
{% endblock %}
